"use strict";(self.webpackChunkwebssh=self.webpackChunkwebssh||[]).push([[349],{1349:function(t,e,s){s.r(e),s.d(e,{default:function(){return D}});var i=s(641);const o={class:"terminal-page"};s(8335),s(4979);var a=s(33);const n={class:"terminal-page-wrapper"},r={class:"terminal-page-container"},l={class:"terminal-area"},c={ref:"terminalRef",class:"xterm-container"},h={class:"terminal-footer"};s(4114);var d=s(4335),u=s(163);s(5129);var p=d.A.create({timeout:15e3,baseURL:"/",validateStatus:function(t){switch(t){case 400:u.nk.error("ËØ∑Ê±ÇÂá∫Èîô");break;case 403:u.nk.warning({ElMessage:"ÊãíÁªùËÆøÈóÆ"});break;case 404:u.nk.warning({ElMessage:"ËØ∑Ê±ÇÈîôËØØ,Êú™ÊâæÂà∞ËØ•ËµÑÊ∫ê"});break;case 500:u.nk.warning({ElMessage:"ÊúçÂä°Á´ØÈîôËØØ"})}return t>=200&&t<300}});p.interceptors.response.use(t=>t.data,t=>(void 0!==t.response||t.config&&t.config.cancelToken||u.nk.error("ËøûÊé•ÊúçÂä°Âô®Â§±Ë¥•"),Promise.reject(t.response)));var m=p,f=s(2975),g=s(9195),w=s(3875),b=s(3751);const k={class:"file-list-wrapper"},$={class:"file-header"},v={class:"el-upload__text"},P={class:"el-upload__tip",slot:"tip"},S={"slot-scope":"scope"},F={key:0,style:{color:"#0c60b5",cursor:"pointer"},class:"el-icon-folder"},y={key:1,style:{cursor:"pointer"},class:"el-icon-document"};var C=s(834),T={name:"FileList",data(){return{uploadVisible:!1,fileList:[],downloadFilePath:"",currentPath:"/",selectTip:"clickSelectFile",titleTip:"uploadFile",uploadTip:"",progressPercent:0,initialRedirectDone:!1,homePath:""}},mounted(){this.currentPath&&"/"!==this.currentPath||this.getFileList()},computed:{...(0,C.aH)(["currentTab"]),sshInfoReady(){return this.$store.state.sshInfo&&this.$store.state.sshInfo.hostname},uploadUrl:()=>`${location.origin}/file/upload`,uploadData:function(){return{sshInfo:this.$store.getters.sshReq,path:this.currentPath}}},watch:{sshInfoReady(t,e){t&&!e&&this.getFileList()},currentTab:function(){this.fileList=[],this.currentPath=this.currentTab&&this.currentTab.path?this.currentTab.path:"/"}},methods:{goToHome(){this.homePath?this.currentPath!==this.homePath&&(this.currentPath=this.homePath,this.getFileList()):this.$message.warning("‰∏ªÁõÆÂΩï‰ø°ÊÅØÂ∞ö‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞ÈáçËØï„ÄÇ")},openUploadDialog(){this.uploadTip=`${this.$t("uploadPath")}: ${this.currentPath}`,this.uploadVisible=!0},handleUploadCommand(t){"folder"===t?(this.selectTip="clickSelectFolder",this.titleTip="uploadFolder"):(this.selectTip="clickSelectFile",this.titleTip="uploadFile"),this.openUploadDialog();const e="folder"===t;this.webkitdirectorySupported()?this.$nextTick(()=>{const t=document.getElementsByClassName("el-upload__input")[0];t&&(t.webkitdirectory=e)}):e&&this.$message.warning("ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅ")},webkitdirectorySupported(){return"webkitdirectory"in document.createElement("input")},beforeUpload(t){this.uploadTip=`${this.$t("uploading")} ${t.name} ${this.$t("to")} ${this.currentPath}, ${this.$t("notCloseWindows")}..`,this.uploadData.id=t.uid;const e=t.webkitRelativePath;return this.uploadData.dir=e?e.substring(0,e.lastIndexOf("/")):"",!0},uploadSuccess(t,e){this.uploadTip=`${e.name}${this.$t("uploadFinish")}!`,this.getFileList()},uploadProgress(t,e){if(t.percent=t.percent/2,e.percentage=e.percentage/2,50===t.percent){const t=new WebSocket(`${"http:"===location.protocol?"ws":"wss"}://${location.host}/file/progress?id=${e.uid}`);t.onmessage=t=>{e.percentage=(e.size+Number(t.data))/(2*e.size)*100},t.onclose=()=>{console.log(Date(),"onclose")},t.onerror=()=>{console.log(Date(),"onerror")}}},nameSort(t,e){return t.Name>e.Name},rowClick(t){t.IsDir?(this.currentPath="/"===this.currentPath.charAt(this.currentPath.length-1)?this.currentPath+t.Name:this.currentPath+"/"+t.Name,this.getFileList()):(this.downloadFilePath="/"===this.currentPath.charAt(this.currentPath.length-1)?this.currentPath+t.Name:this.currentPath+"/"+t.Name,this.downloadFile())},async getFileList(){this.currentPath=this.currentPath.replace(/\\+/g,"/"),""===this.currentPath&&(this.currentPath="/");const t=await(e=this.currentPath,s=this.$store.getters.sshReq,m.get(`/file/list?path=${e}&sshInfo=${s}`));var e,s;if("success"===t.Msg){if(t.Data.home&&(this.homePath=t.Data.home),null===t.Data.list?this.fileList=[]:this.fileList=t.Data.list,!this.initialRedirectDone&&t.Data.home&&"/"!==t.Data.home&&this.currentPath!==t.Data.home)return this.initialRedirectDone=!0,this.currentPath=t.Data.home,void await this.getFileList()}else this.fileList=[],this.$message({message:t.Msg,type:"error",duration:3e3})},upDirectory(){if("/"===this.currentPath)return;let t=this.currentPath.split("/");t=""===t[t.length-1]?t.slice(0,t.length-2):t.slice(0,t.length-1),this.currentPath=1===t.length?"/":t.join("/"),this.getFileList()},downloadFile(){const t=`${location.origin}/file/download?path=${this.downloadFilePath}&sshInfo=${this.$store.getters.sshReq}`;window.open(t)}}},L=s(6262),_={name:"Terminal",components:{FileList:(0,L.A)(T,[["render",function(t,e,s,o,n,r){const l=(0,i.g2)("el-input"),c=(0,i.g2)("el-button"),h=(0,i.g2)("el-dropdown-item"),d=(0,i.g2)("el-dropdown-menu"),u=(0,i.g2)("el-dropdown"),p=(0,i.g2)("el-button-group"),m=(0,i.g2)("upload"),f=(0,i.g2)("el-icon"),g=(0,i.g2)("el-upload"),w=(0,i.g2)("el-dialog"),C=(0,i.g2)("el-table-column"),T=(0,i.g2)("el-table");return(0,i.uX)(),(0,i.CE)("div",k,[e[6]||(e[6]=(0,i.Lk)("div",{class:"sftp-title"},"SFTPÊñá‰ª∂ÁÆ°ÁêÜ",-1)),(0,i.Lk)("div",$,[(0,i.bF)(l,{class:"path-input",modelValue:n.currentPath,"onUpdate:modelValue":e[0]||(e[0]=t=>n.currentPath=t),size:"small",onKeyup:e[1]||(e[1]=(0,b.jR)(t=>r.getFileList(),["enter","native"])),onBlur:r.getFileList,placeholder:"ÂΩìÂâçË∑ØÂæÑ..."},null,8,["modelValue","onBlur"]),(0,i.bF)(p,null,{default:(0,i.k6)(()=>[(0,i.bF)(c,{type:"primary",size:"small",icon:"el-icon-s-home",onClick:e[2]||(e[2]=t=>r.goToHome()),title:"‰∏ªÁõÆÂΩï"}),(0,i.bF)(c,{type:"primary",size:"small",icon:"el-icon-arrow-up",onClick:e[3]||(e[3]=t=>r.upDirectory()),title:"ËøîÂõû‰∏äÁ∫ßÁõÆÂΩï"}),(0,i.bF)(c,{type:"primary",size:"small",icon:"el-icon-refresh",onClick:e[4]||(e[4]=t=>r.getFileList()),title:"Âà∑Êñ∞ÂΩìÂâçÁõÆÂΩï"}),(0,i.bF)(u,{onClick:e[5]||(e[5]=t=>r.openUploadDialog()),onCommand:r.handleUploadCommand,size:"small"},{default:(0,i.k6)(()=>[(0,i.bF)(c,{type:"primary",size:"small",icon:"el-icon-upload"}),(0,i.bF)(d,{slot:"dropdown"},{default:(0,i.k6)(()=>[(0,i.bF)(h,{command:"file"},{default:(0,i.k6)(()=>[(0,i.eW)((0,a.v_)(t.$t("uploadFile")),1)]),_:1}),(0,i.bF)(h,{command:"folder"},{default:(0,i.k6)(()=>[(0,i.eW)((0,a.v_)(t.$t("uploadFolder")),1)]),_:1})]),_:1})]),_:1},8,["onCommand"])]),_:1})]),(0,i.bF)(w,{"custom-class":"uploadContainer",title:t.$t(this.titleTip),visible:n.uploadVisible,"append-to-body":"",width:"32%"},{default:(0,i.k6)(()=>[(0,i.bF)(g,{ref:"upload",multiple:"",drag:"",action:r.uploadUrl,data:r.uploadData,"before-upload":r.beforeUpload,"on-progress":r.uploadProgress,"on-success":r.uploadSuccess},{default:(0,i.k6)(()=>[(0,i.bF)(f,null,{default:(0,i.k6)(()=>[(0,i.bF)(m)]),_:1}),(0,i.Lk)("div",v,(0,a.v_)(t.$t(this.selectTip)),1),(0,i.Lk)("div",P,(0,a.v_)(this.uploadTip),1)]),_:1},8,["action","data","before-upload","on-progress","on-success"])]),_:1},8,["title","visible"]),(0,i.bF)(T,{data:n.fileList,class:"file-table",onRowClick:r.rowClick,height:"100%"},{default:(0,i.k6)(()=>[(0,i.bF)(C,{label:t.$t("Name"),width:"140",sortable:"","sort-method":r.nameSort},{default:(0,i.k6)(()=>[(0,i.Lk)("template",S,[!0===t.scope.row.IsDir?((0,i.uX)(),(0,i.CE)("p",F,(0,a.v_)(t.scope.row.Name),1)):!1===t.scope.row.IsDir?((0,i.uX)(),(0,i.CE)("p",y,(0,a.v_)(t.scope.row.Name),1)):(0,i.Q3)("",!0)])]),_:1},8,["label","sort-method"]),(0,i.bF)(C,{label:t.$t("Size"),prop:"Size",width:"80"},null,8,["label"]),(0,i.bF)(C,{label:t.$t("ModifiedTime"),prop:"ModifyTime",width:"120",sortable:""},null,8,["label"])]),_:1},8,["data","onRowClick"])])}]])},data(){return{term:null,ws:null,resetClose:!1,ssh:null,savePass:!1,fontSize:15,isSftpVisible:!1,fitAddon:null}},mounted(){this.$nextTick(()=>{this.createTerm(),window.addEventListener("resize",this.onWindowResize)})},beforeUnmount(){this.close(),window.removeEventListener("resize",this.onWindowResize)},methods:{toggleSftpPanel(){this.isSftpVisible=!this.isSftpVisible,setTimeout(()=>{if(this.fitAddon)try{this.fitAddon.fit()}catch(t){console.warn(t)}},300)},onWindowResize(){if(this.fitAddon)try{this.fitAddon.fit()}catch(t){}this.ws&&1===this.ws.readyState&&this.term&&this.ws.send(`resize:${this.term.rows}:${this.term.cols}`)},createTerm(){const t=this.$store.state.sshInfo;if(!t||!t.hostname)return this.$message.error("Êó†ÊïàÁöÑËøûÊé•‰ø°ÊÅØÔºÅÊ≠£Âú®ËøîÂõûÁôªÂΩïÈ°µ..."),void this.$router.push("/");const e=this.$refs.terminalRef;if(!e)return void console.error("Terminal container not found.");const s=this.$store.getters.sshReq;this.close(),this.fitAddon=new g.FitAddon,this.term=new f.Terminal({cursorBlink:!0,cursorStyle:"bar",cursorWidth:2,fontFamily:'Menlo, Monaco, "Courier New", monospace',fontSize:this.fontSize,theme:{background:"#000000",foreground:"#ffffff",cursor:"#ffffff",selection:"#daffe77a"}}),this.term.loadAddon(this.fitAddon),this.term.open(e),this.term.focus();try{this.fitAddon.fit()}catch(t){}this.term.write("[1;1H[1;32mÊ≠£Âú®ËøûÊé• "+t.hostname+"...[0m\r\n");const i=this,o={timeout:5e3,intervalObj:null,stop:function(){this.intervalObj&&clearInterval(this.intervalObj)},start:function(){this.intervalObj=setInterval(function(){null!==i.ws&&1===i.ws.readyState&&i.ws.send("ping")},this.timeout)}};let a="Â∑≤Ë∂ÖÊó∂ÂÖ≥Èó≠!";"en"===this.$store.state.language&&(a="Connection timed out!");const n=`${"https:"===location.protocol?"wss":"ws"}://${location.host}/term?sshInfo=${s}&rows=${this.term.rows}&cols=${this.term.cols}&closeTip=${a}`;this.ws=new WebSocket(n),this.ws.onopen=()=>{console.log("WebSocket Connected"),i.connected(),o.start(),i._initCmdSent=!1,setTimeout(()=>{try{i.fitAddon.fit()}catch(t){}},100)},this.ws.onmessage=t=>{"string"==typeof t.data&&setTimeout(()=>{if(!i._initCmdSent&&i.ssh){const t=i.term;if(!t||!t.buffer||!t.buffer.active)return;const e=t.buffer.active.baseY+t.buffer.active.cursorY,s=t.buffer.active.getLine(e);if(s){const t=s.translateToString();/[>$#%]\s*$/.test(t.trimEnd())&&(i._initCmdSent=!0,i.term.write("[s[1;1H[2K[u"),i.ssh.command&&setTimeout(()=>{i.ws&&1===i.ws.readyState&&i.ws.send(i.ssh.command+"\r")},100))}}},10)},this.ws.onclose=()=>{i.resetClose||(i.ssh&&!this.savePass&&(this.$store.commit("SET_PASS",""),i.ssh&&(i.ssh.password="")),this.$message({message:this.$t?this.$t("wsClose"):"ËøûÊé•Â∑≤Êñ≠ÂºÄ",type:"warning",duration:3e3,showClose:!0}),this.ws=null),o.stop(),i.resetClose=!1},this.ws.onerror=t=>{console.error("WS Error:",t)};const r=new w.AttachAddon(this.ws,{bidirectional:!1});this.term.loadAddon(r),this.term.onData(t=>{i.ws&&1===i.ws.readyState&&i.ws.send(t)}),e.addEventListener("wheel",t=>{if(t.ctrlKey){t.preventDefault(),t.deltaY<0?i.fontSize++:i.fontSize=Math.max(10,i.fontSize-1),i.term.setOption("fontSize",i.fontSize);try{i.fitAddon.fit()}catch(t){}}},{passive:!1})},async connected(){const t=this.$store.state.sshInfo;this.ssh=Object.assign({},t);try{const t=await function(t){return m.get(`/check?sshInfo=${t}`)}(this.$store.getters.sshReq);if("success"!==t.Msg)return;this.savePass=t.Data.savePass}catch(t){console.error(t)}document.title=t.hostname||"WebSSH",this.$store.state.sshList},close(){null!==this.ws&&(this.ws.close(),this.resetClose=!0),null!==this.term&&(this.term.dispose(),this.term=null)}}},I={components:{Terminal:(0,L.A)(_,[["render",function(t,e,s,o,d,u){const p=(0,i.g2)("FileList");return(0,i.uX)(),(0,i.CE)("div",n,[(0,i.Lk)("div",r,[(0,i.Lk)("div",l,[(0,i.Lk)("div",c,null,512)]),(0,i.Lk)("div",{class:(0,a.C4)(["file-tree",{"is-visible":d.isSftpVisible}])},[(0,i.bF)(p)],2)]),(0,i.Lk)("div",h,[e[2]||(e[2]=(0,i.Lk)("a",{href:"https://github.com/adamj001/webssh-lw",target:"_blank",class:"github-link",title:"GitHub"},[(0,i.Lk)("i",{class:"fab fa-github"})],-1)),(0,i.Lk)("button",{onClick:e[0]||(e[0]=(...t)=>u.toggleSftpPanel&&u.toggleSftpPanel(...t)),class:"sftp-toggle-btn",title:"Êñá‰ª∂ÁÆ°ÁêÜ"},[...e[1]||(e[1]=[(0,i.Lk)("i",{class:"fas fa-folder-open",style:{"margin-left":"15px"}},null,-1)])])])])}],["__scopeId","data-v-19d0f284"]])},beforeCreate(){let{hostname:t,port:e,username:s,password:i,command:o,privateKey:a,passphrase:n,useKey:r}=this.$route.query;if(t&&(t=decodeURIComponent(t)),s&&(s=decodeURIComponent(s)),i)try{i=atob(i)}catch(t){i=decodeURIComponent(i)}if(o&&(o=decodeURIComponent(o)),a&&(a=decodeURIComponent(a)),n&&(n=decodeURIComponent(n)),r){const r=sessionStorage.getItem("sshInfo");if(r){const l=JSON.parse(r);t=l.hostname,e=l.port,s=l.username,i=l.password,o=l.command,a=l.privateKey,n=l.passphrase}}else if(!t||!s||!i&&!a){const r=sessionStorage.getItem("sshInfo");if(r){const l=JSON.parse(r);t=l.hostname,e=l.port,s=l.username,i=l.password,o=l.command,a=l.privateKey,n=l.passphrase}}t&&s&&(i||a)&&this.$store.commit("SET_SSH",{hostname:t,port:Number(e)||22,username:s,password:i,command:o,privateKey:a,passphrase:n})}},D=(0,L.A)(I,[["render",function(t,e,s,a,n,r){const l=(0,i.g2)("Terminal");return(0,i.uX)(),(0,i.CE)("div",o,[(0,i.bF)(l)])}],["__scopeId","data-v-5dbc5070"]])}}]);