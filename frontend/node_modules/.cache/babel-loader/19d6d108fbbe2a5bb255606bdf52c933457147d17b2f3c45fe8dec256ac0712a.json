{"ast":null,"code":"import { createElementVNode as _createElementVNode, resolveComponent as _resolveComponent, createVNode as _createVNode, normalizeClass as _normalizeClass, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\";\nconst _hoisted_1 = {\n  class: \"terminal-page-wrapper\"\n};\nconst _hoisted_2 = {\n  class: \"terminal-page-container\"\n};\nconst _hoisted_3 = {\n  class: \"terminal-footer\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_FileList = _resolveComponent(\"FileList\");\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"div\", _hoisted_2, [_cache[1] || (_cache[1] = _createElementVNode(\"div\", {\n    class: \"terminal-area\"\n  }, [_createElementVNode(\"div\", {\n    id: \"xterm-container\"\n  })], -1 /* CACHED */)), _createElementVNode(\"div\", {\n    class: _normalizeClass([\"file-tree\", {\n      'is-visible': $data.isSftpVisible\n    }])\n  }, [_createVNode(_component_FileList)], 2 /* CLASS */)]), _createElementVNode(\"div\", _hoisted_3, [_cache[3] || (_cache[3] = _createElementVNode(\"a\", {\n    href: \"https://github.com/adamj001/webssh-lw\",\n    target: \"_blank\",\n    class: \"github-link\",\n    title: \"GitHub\"\n  }, [_createElementVNode(\"i\", {\n    class: \"fab fa-github\"\n  })], -1 /* CACHED */)), _createElementVNode(\"button\", {\n    onClick: _cache[0] || (_cache[0] = (...args) => $options.toggleSftpPanel && $options.toggleSftpPanel(...args)),\n    class: \"sftp-toggle-btn\",\n    title: \"文件管理\"\n  }, [...(_cache[2] || (_cache[2] = [_createElementVNode(\"i\", {\n    class: \"fas fa-folder-open\",\n    style: {\n      \"margin-left\": \"15px\"\n    }\n  }, null, -1 /* CACHED */)]))])])]);\n}","map":{"version":3,"names":["class","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","id","_normalizeClass","$data","isSftpVisible","_createVNode","_component_FileList","_hoisted_3","href","target","title","onClick","_cache","args","$options","toggleSftpPanel","style"],"sources":["C:\\Users\\Adam\\Desktop\\wssh\\webssh\\frontend\\src\\components\\Terminal.vue"],"sourcesContent":["<template>\r\n  <div class=\"terminal-page-wrapper\">\r\n    <div class=\"terminal-page-container\">\r\n      <div class=\"terminal-area\">\r\n        <div id=\"xterm-container\"></div>\r\n      </div>\r\n      <div class=\"file-tree\" :class=\"{ 'is-visible': isSftpVisible }\">\r\n        <FileList />\r\n      </div>\r\n    </div>\r\n    <div class=\"terminal-footer\">\r\n    \r\n      <a href=\"https://github.com/adamj001/webssh-lw\" target=\"_blank\" class=\"github-link\" title=\"GitHub\">\r\n        <i class=\"fab fa-github\"></i>\r\n      </a>\r\n      <button @click=\"toggleSftpPanel\" class=\"sftp-toggle-btn\" title=\"文件管理\">\r\n        <i class=\"fas fa-folder-open\" style=\"margin-left: 15px;\"></i>\r\n      </button>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { checkSSH } from '@/api/common'\r\nimport { Terminal } from 'xterm'\r\nimport { FitAddon } from 'xterm-addon-fit'\r\nimport { AttachAddon } from 'xterm-addon-attach'\r\nimport FileList from '@/components/FileList'\r\n\r\nexport default {\r\n    name: 'Terminal',\r\n    components: { FileList },\r\n    data() {\r\n        return {\r\n            term: null,\r\n            ws: null,\r\n            resetClose: false,\r\n            ssh: null,\r\n            savePass: false,\r\n            fontSize: 15,\r\n            isSftpVisible: false\r\n        }\r\n    },\r\n    mounted() {\r\n        this.$nextTick(() => {\r\n            this.createTerm()\r\n        })\r\n    },\r\n    methods: {\r\n        toggleSftpPanel() {\r\n            this.isSftpVisible = !this.isSftpVisible\r\n        },\r\n        setSSH() {\r\n            this.$store.commit('SET_SSH', this.ssh)\r\n        },\r\n        resizeTerm() {\r\n            // This is now handled by CSS flexbox and xterm's fit-addon.\r\n            // The logic is kept here in case of future need.\r\n        },\r\n        createTerm() {\r\n            const sshInfo = this.$store.state.sshInfo;\r\n            if (!sshInfo || !sshInfo.hostname) {\r\n                this.$message.error('无效的连接信息！正在返回登录页...')\r\n                this.$router.push('/')\r\n                return\r\n            }\r\n            const termWeb = document.getElementById('xterm-container')\r\n            if (!termWeb) {\r\n                console.error('Terminal container #xterm-container not found.')\r\n                return\r\n            }\r\n            const sshReq = this.$store.getters.sshReq\r\n            this.close()\r\n            const prefix = process.env.NODE_ENV === 'production' ? '' : '/api'\r\n            const fitAddon = new FitAddon()\r\n            this.term = new Terminal({\r\n                cursorBlink: true,\r\n                cursorStyle: 'bar',\r\n                cursorWidth: 4,\r\n                fontFamily: 'DejaVu Sans Mono, monospace',  // 设置字体\r\n                fontSize: this.fontSize,            // 字号\r\n                theme: {\r\n                    background: '#000000',          // 背景色\r\n                    foreground: '#ffffff',          // 字体颜色\r\n                    cursor: '#ffffff',              // 光标颜色\r\n                    selection: '#daffe77a',         // 选中区域颜色\r\n                    blue: '#1981ff',                // 蓝色\r\n                    brightMagenta: '#e879f9',       // 紫色\r\n                    brightBlue: '#6eb0ff',          // 亮蓝色\r\n                }\r\n            })\r\n            this.term.loadAddon(fitAddon)\r\n            this.term.open(document.getElementById('xterm-container'))\r\n            this.term.focus()\r\n            this.term.write('\\x1b[1;1H\\x1b[1;32m正在连接，请稍后...\\x1b[0m\\r\\n')\r\n            try { fitAddon.fit() } catch (e) {/**/}\r\n            const self = this\r\n            const heartCheck = {\r\n                timeout: 5000, // 5s发一次心跳\r\n                intervalObj: null,\r\n                stop: function() {\r\n                    clearInterval(this.intervalObj)\r\n                },\r\n                start: function() {\r\n                    this.intervalObj = setInterval(function() {\r\n                        if (self.ws !== null && self.ws.readyState === 1) {\r\n                            self.ws.send('ping')\r\n                        }\r\n                    }, this.timeout)\r\n                }\r\n            }\r\n            let closeTip = '已超时关闭!'\r\n            if (this.$store.state.language === 'en') {\r\n                closeTip = 'Connection timed out!'\r\n            }\r\n            // open websocket\r\n            this.ws = new WebSocket(`${(location.protocol === 'http:' ? 'ws' : 'wss')}://${location.host}${prefix}/term?sshInfo=${sshReq}&rows=${this.term.rows}&cols=${this.term.cols}&closeTip=${closeTip}`)\r\n            this.ws.onopen = () => {\r\n                console.log(Date(), 'onopen')\r\n                self.connected()\r\n                heartCheck.start()\r\n                self._initCmdSent = false\r\n            }\r\n            // 监听ws消息，检测到提示符再自动执行初始命令并清理提示\r\n            this.ws.onmessage = (event) => {\r\n                if (typeof event.data === 'string') {\r\n                    // We need to wait for the attach addon to process the data and write it to the terminal.\r\n                    // A timeout of 0ms should be enough to push this to the end of the execution queue.\r\n                    setTimeout(() => {\r\n                        if (!self._initCmdSent && self.ssh) {\r\n                            const term = self.term;\r\n                            if (!term || !term.buffer || !term.buffer.active) return;\r\n\r\n                            const currentLineNumber = term.buffer.active.baseY + term.buffer.active.cursorY;\r\n                            const line = term.buffer.active.getLine(currentLineNumber);\r\n                            if (line) {\r\n                                const lineText = line.translateToString();\r\n                                // More robust regex to detect various shell prompts at the end of the line\r\n                                if (/[>$#%]\\s*$/.test(lineText.trimEnd())) {\r\n                                    self._initCmdSent = true;\r\n                                    // This ANSI sequence saves cursor, moves to 1,1, clears line, and restores cursor\r\n                                    self.term.write('\\x1b[s\\x1b[1;1H\\x1b[2K\\x1b[u');\r\n                                    if (self.ssh.command) {\r\n                                        setTimeout(() => {\r\n                                            if (self.ws && self.ws.readyState === 1) {\r\n                                                self.ws.send(self.ssh.command + '\\r'); // 让后端执行命令\r\n                                            }\r\n                                        }, 100);\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }, 10);\r\n                }\r\n            }\r\n            this.ws.onclose = () => {\r\n                console.log(Date(), 'onclose')\r\n                if (!self.resetClose) {\r\n                    if (self.ssh && !this.savePass) {\r\n                        this.$store.commit('SET_PASS', '')\r\n                        self.ssh.password = ''\r\n                    }\r\n                    this.$message({\r\n                        message: this.$t('wsClose'),\r\n                        type: 'warning',\r\n                        duration: 0,\r\n                        showClose: true\r\n                    })\r\n                    this.ws = null\r\n                }\r\n                heartCheck.stop()\r\n                self.resetClose = false\r\n                if (self.ws !== null && self.ws.readyState === 1) {\r\n                    self.ws.send(`resize:${self.term.rows}:${self.term.cols}`)\r\n                }\r\n            }\r\n            this.ws.onerror = () => {\r\n                console.log(Date(), 'onerror')\r\n            }\r\n            const attachAddon = new AttachAddon(this.ws, { bidirectional: false })\r\n            this.term.loadAddon(attachAddon)\r\n\r\n            // 恢复终端输入到ws\r\n            this.term.onData(data => {\r\n                if (self.ws && self.ws.readyState === 1) {\r\n                    self.ws.send(data)\r\n                }\r\n            })\r\n\r\n            this.term.attachCustomKeyEventHandler((e) => {\r\n                const keyArray = ['F5', 'F11', 'F12']\r\n                if (keyArray.indexOf(e.key) > -1) {\r\n                    return false\r\n                }\r\n                // ctrl + v\r\n                if (e.ctrlKey && e.key === 'v') {\r\n                    document.execCommand('copy')\r\n                    return false\r\n                }\r\n                // ctrl + c\r\n                if (e.ctrlKey && e.key === 'c' && self.term.hasSelection()) {\r\n                    document.execCommand('copy')\r\n                    return false\r\n                }\r\n            })\r\n            // detect available wheel event\r\n            // 各个厂商的高版本浏览器都支持\"wheel\"\r\n            // Webkit 和 IE一定支持\"mousewheel\"\r\n            // \"DOMMouseScroll\" 用于低版本的firefox\r\n            const wheelSupport = 'onwheel' in document.createElement('div') ? 'wheel' : document.onmousewheel !== undefined ? 'mousewheel' : 'DOMMouseScroll'\r\n            termWeb.addEventListener(wheelSupport, (e) => {\r\n                if (e.ctrlKey) {\r\n                    e.preventDefault()\r\n                    if (e.deltaY < 0) {\r\n                        self.term.setOption('fontSize', ++this.fontSize)\r\n                    } else {\r\n                        self.term.setOption('fontSize', --this.fontSize)\r\n                    }\r\n                    try { fitAddon.fit() } catch (e) {/**/}\r\n                    if (self.ws !== null && self.ws.readyState === 1) {\r\n                        self.ws.send(`resize:${self.term.rows}:${self.term.cols}`)\r\n                    }\r\n                }\r\n            })\r\n            window.addEventListener('resize', () => {\r\n                try { fitAddon.fit() } catch (e) {/**/}\r\n                if (self.ws !== null && self.ws.readyState === 1) {\r\n                    self.ws.send(`resize:${self.term.rows}:${self.term.cols}`)\r\n                }\r\n            })\r\n        },\r\n        async connected() {\r\n            const sshInfo = this.$store.state.sshInfo\r\n            // 深度拷贝对象\r\n            this.ssh = Object.assign({}, sshInfo)\r\n            // 校验ssh连接信息是否正确\r\n            const result = await checkSSH(this.$store.getters.sshReq)\r\n            if (result.Msg !== 'success') {\r\n                return\r\n            } else {\r\n                this.savePass = result.Data.savePass\r\n            }\r\n            document.title = sshInfo.hostname\r\n            let sshList = this.$store.state.sshList\r\n            if (sshList === null) {\r\n                if (this.savePass) {\r\n                    sshList = `[{\"hostname\": \"${sshInfo.hostname}\", \"username\": \"${sshInfo.username}\", \"port\":${sshInfo.port}, \"logintype\":${sshInfo.logintype}, \"password\":\"${sshInfo.password}\"}]`\r\n                } else {\r\n                    sshList = `[{\"hostname\": \"${sshInfo.hostname}\", \"username\": \"${sshInfo.username}\", \"port\":${sshInfo.port},  \"logintype\":${sshInfo.logintype}}]`\r\n                }\r\n            } else {\r\n                const sshListObj = JSON.parse(window.atob(sshList))\r\n                sshListObj.forEach((v, i) => {\r\n                    if (v.hostname === sshInfo.hostname) {\r\n                        sshListObj.splice(i, 1)\r\n                    }\r\n                })\r\n                sshListObj.push({\r\n                    hostname: sshInfo.hostname,\r\n                    username: sshInfo.username,\r\n                    port: sshInfo.port,\r\n                    logintype: sshInfo.logintype\r\n                })\r\n                if (this.savePass) {\r\n                    sshListObj[sshListObj.length - 1].password = sshInfo.password\r\n                }\r\n                sshList = JSON.stringify(sshListObj)\r\n            }\r\n            this.$store.commit('SET_LIST', window.btoa(sshList))\r\n        },\r\n        close() {\r\n            if (this.ws !== null) {\r\n                this.ws.close()\r\n                this.resetClose = true\r\n            }\r\n            if (this.term !== null) {\r\n                this.term.dispose()\r\n            }\r\n        }\r\n    },\r\n    beforeDestroy() {\r\n        this.close()\r\n    }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.terminal-page-wrapper {\r\n  display: flex;\r\n  flex-direction: column;\r\n  flex-grow: 1; /* This will make it fill the space given by App.vue */\r\n  min-height: 0; /* Prevents overflow issues */\r\n  background: var(--card-bg);\r\n  box-shadow: var(--shadow);\r\n}\r\n\r\n.terminal-page-container {\r\n  display: flex;\r\n  flex-grow: 1;\r\n  min-height: 0;\r\n  overflow: hidden;\r\n}\r\n\r\n.terminal-area {\r\n  flex: 1;\r\n  min-width: 0;\r\n  display: flex;\r\n  flex-direction: column;\r\n  background-color: black;\r\n}\r\n\r\n#xterm-container {\r\n  flex-grow: 1;\r\n  width: 100%;\r\n  padding-left: 2px;\r\n}\r\n\r\n.file-tree {\r\n  width: 350px;\r\n  border-left: 1px solid var(--input-border);\r\n  background: var(--input-bg);\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n\r\n.terminal-footer {\r\n  width: 100%;\r\n  margin-left: -3rem;\r\n  text-align: center;\r\n  padding: 8px 0 6px 0;\r\n  font-size: 15px;\r\n  color: #0e0e0e;\r\n  background: var(--card-bg);\r\n  border-top: 1px solid var(--input-border);\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  gap: 8px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.github-link {\r\n  color: #0e0e0e;\r\n  margin-left: 4px;\r\n  font-size: 18px;\r\n  transition: color 0.2s;\r\n}\r\n\r\n.github-link:hover {\r\n  color: var(--text-primary);\r\n}\r\n\r\n.sftp-toggle-btn {\r\n  display: none;\r\n  background: none;\r\n  border: none;\r\n  color: #0e0e0e;\r\n  font-size: 18px;\r\n  cursor: pointer;\r\n  padding: 0;\r\n  line-height: 1;\r\n}\r\n\r\n.sftp-toggle-btn:hover {\r\n  color: var(--text-primary);\r\n}\r\n\r\n@media (max-width: 768px) {\r\n  .sftp-toggle-btn {\r\n    display: inline-block;\r\n  }\r\n\r\n  .terminal-page-container {\r\n    position: relative;\r\n    overflow: hidden; /* Contain the sliding panel */\r\n  }\r\n\r\n  .file-tree {\r\n    position: absolute;\r\n    top: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    width: 85%;\r\n    max-width: 350px;\r\n    transform: translateX(100%);\r\n    transition: transform 0.3s ease-in-out;\r\n    z-index: 20;\r\n    border-left: none;\r\n    box-shadow: -2px 0 10px rgba(0,0,0,0.15);\r\n  }\r\n\r\n  .file-tree.is-visible {\r\n    transform: translateX(0);\r\n  }\r\n\r\n  .terminal-footer {\r\n    margin-left: 0;\r\n    width: 100%;\r\n  }\r\n}\r\n</style>\r\n"],"mappings":";;EACOA,KAAK,EAAC;AAAuB;;EAC3BA,KAAK,EAAC;AAAyB;;EAQ/BA,KAAK,EAAC;AAAiB;;;uBAT9BC,mBAAA,CAkBM,OAlBNC,UAkBM,GAjBJC,mBAAA,CAOM,OAPNC,UAOM,G,0BANJD,mBAAA,CAEM;IAFDH,KAAK,EAAC;EAAe,IACxBG,mBAAA,CAAgC;IAA3BE,EAAE,EAAC;EAAiB,G,qBAE3BF,mBAAA,CAEM;IAFDH,KAAK,EAAAM,eAAA,EAAC,WAAW;MAAA,cAAyBC,KAAA,CAAAC;IAAa;MAC1DC,YAAA,CAAYC,mBAAA,E,oBAGhBP,mBAAA,CAQM,OARNQ,UAQM,G,0BANJR,mBAAA,CAEI;IAFDS,IAAI,EAAC,uCAAuC;IAACC,MAAM,EAAC,QAAQ;IAACb,KAAK,EAAC,aAAa;IAACc,KAAK,EAAC;MACxFX,mBAAA,CAA6B;IAA1BH,KAAK,EAAC;EAAe,G,qBAE1BG,mBAAA,CAES;IAFAY,OAAK,EAAAC,MAAA,QAAAA,MAAA,UAAAC,IAAA,KAAEC,QAAA,CAAAC,eAAA,IAAAD,QAAA,CAAAC,eAAA,IAAAF,IAAA,CAAe;IAAEjB,KAAK,EAAC,iBAAiB;IAACc,KAAK,EAAC;qCAC7DX,mBAAA,CAA6D;IAA1DH,KAAK,EAAC,oBAAoB;IAACoB,KAA0B,EAA1B;MAAA;IAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}