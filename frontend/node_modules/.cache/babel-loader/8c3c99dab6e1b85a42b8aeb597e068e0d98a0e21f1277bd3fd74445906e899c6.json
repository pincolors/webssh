{"ast":null,"code":"import { fileList } from '@/api/file';\nimport { mapState } from 'vuex';\nexport default {\n  name: 'FileList',\n  data() {\n    return {\n      uploadVisible: false,\n      fileList: [],\n      downloadFilePath: '',\n      currentPath: '/',\n      selectTip: 'clickSelectFile',\n      titleTip: 'uploadFile',\n      uploadTip: '',\n      progressPercent: 0,\n      initialRedirectDone: false,\n      homePath: ''\n    };\n  },\n  mounted() {\n    // 组件挂载时，currentPath 为空或/，自动拉取\n    if (!this.currentPath || this.currentPath === '/') {\n      this.getFileList();\n    }\n  },\n  computed: {\n    ...mapState(['currentTab']),\n    // currentTab may be deprecated but keeping for now\n    sshInfoReady() {\n      return this.$store.state.sshInfo && this.$store.state.sshInfo.hostname;\n    },\n    uploadUrl: () => {\n      return `${process.env.NODE_ENV === 'production' ? `${location.origin}` : 'api'}/file/upload`;\n    },\n    uploadData: function () {\n      return {\n        sshInfo: this.$store.getters.sshReq,\n        path: this.currentPath\n      };\n    }\n  },\n  watch: {\n    // Watch for sshInfo to become available\n    sshInfoReady(newValue, oldValue) {\n      if (newValue && !oldValue) {\n        this.getFileList();\n      }\n    },\n    currentTab: function () {\n      // This logic might need adjustment if multi-tab is re-enabled\n      this.fileList = [];\n      this.currentPath = this.currentTab && this.currentTab.path ? this.currentTab.path : '/';\n    }\n  },\n  methods: {\n    goToHome() {\n      if (this.homePath) {\n        if (this.currentPath !== this.homePath) {\n          this.currentPath = this.homePath;\n          this.getFileList();\n        }\n      } else {\n        this.$message.warning('主目录信息尚不可用，请刷新重试。');\n      }\n    },\n    openUploadDialog() {\n      this.uploadTip = `${this.$t('uploadPath')}: ${this.currentPath}`;\n      this.uploadVisible = true;\n    },\n    handleUploadCommand(cmd) {\n      if (cmd === 'folder') {\n        this.selectTip = 'clickSelectFolder';\n        this.titleTip = 'uploadFolder';\n      } else {\n        this.selectTip = 'clickSelectFile';\n        this.titleTip = 'uploadFile';\n      }\n      this.openUploadDialog();\n      const isFolder = 'folder' === cmd,\n        supported = this.webkitdirectorySupported();\n      if (!supported) {\n        isFolder && this.$message.warning('当前浏览器不支持');\n        return;\n      }\n      // Add folder support\n      this.$nextTick(() => {\n        const input = document.getElementsByClassName('el-upload__input')[0];\n        if (input) input.webkitdirectory = isFolder;\n      });\n    },\n    webkitdirectorySupported() {\n      return 'webkitdirectory' in document.createElement('input');\n    },\n    beforeUpload(file) {\n      this.uploadTip = `${this.$t('uploading')} ${file.name} ${this.$t('to')} ${this.currentPath}, ${this.$t('notCloseWindows')}..`;\n      this.uploadData.id = file.uid;\n      // Is there a folder?\n      const dirPath = file.webkitRelativePath;\n      this.uploadData.dir = dirPath ? dirPath.substring(0, dirPath.lastIndexOf('/')) : '';\n      return true;\n    },\n    uploadSuccess(r, file) {\n      this.uploadTip = `${file.name}${this.$t('uploadFinish')}!`;\n      this.getFileList();\n    },\n    uploadProgress(e, f) {\n      e.percent = e.percent / 2;\n      f.percentage = f.percentage / 2;\n      if (e.percent === 50) {\n        const ws = new WebSocket(`${location.protocol === 'http:' ? 'ws' : 'wss'}://${location.host}${process.env.NODE_ENV === 'production' ? '' : '/ws'}/file/progress?id=${f.uid}`);\n        ws.onmessage = e1 => {\n          f.percentage = (f.size + Number(e1.data)) / (f.size * 2) * 100;\n        };\n        ws.onclose = () => {\n          console.log(Date(), 'onclose');\n        };\n        ws.onerror = () => {\n          console.log(Date(), 'onerror');\n        };\n      }\n    },\n    nameSort(a, b) {\n      return a.Name > b.Name;\n    },\n    rowClick(row) {\n      if (row.IsDir) {\n        // Folder handling\n        this.currentPath = this.currentPath.charAt(this.currentPath.length - 1) === '/' ? this.currentPath + row.Name : this.currentPath + '/' + row.Name;\n        this.getFileList();\n      } else {\n        // File handling\n        this.downloadFilePath = this.currentPath.charAt(this.currentPath.length - 1) === '/' ? this.currentPath + row.Name : this.currentPath + '/' + row.Name;\n        this.downloadFile();\n      }\n    },\n    async getFileList() {\n      this.currentPath = this.currentPath.replace(/\\\\+/g, '/');\n      if (this.currentPath === '') {\n        this.currentPath = '/';\n      }\n      const result = await fileList(this.currentPath, this.$store.getters.sshReq);\n      if (result.Msg === 'success') {\n        if (result.Data.home) {\n          this.homePath = result.Data.home;\n        }\n        if (result.Data.list === null) {\n          this.fileList = [];\n        } else {\n          this.fileList = result.Data.list;\n        }\n        // 只要后端返回的home和当前路径不同且home不为/，就切换 (仅执行一次)\n        if (!this.initialRedirectDone && result.Data.home && result.Data.home !== '/' && this.currentPath !== result.Data.home) {\n          this.initialRedirectDone = true;\n          this.currentPath = result.Data.home;\n          await this.getFileList();\n          return;\n        }\n      } else {\n        this.fileList = [];\n        this.$message({\n          message: result.Msg,\n          type: 'error',\n          duration: 3000\n        });\n      }\n    },\n    upDirectory() {\n      if (this.currentPath === '/') {\n        return;\n      }\n      let pathList = this.currentPath.split('/');\n      if (pathList[pathList.length - 1] === '') {\n        pathList = pathList.slice(0, pathList.length - 2);\n      } else {\n        pathList = pathList.slice(0, pathList.length - 1);\n      }\n      this.currentPath = pathList.length === 1 ? '/' : pathList.join('/');\n      this.getFileList();\n    },\n    downloadFile() {\n      const prefix = process.env.NODE_ENV === 'production' ? `${location.origin}` : 'api';\n      const downloadUrl = `${prefix}/file/download?path=${this.downloadFilePath}&sshInfo=${this.$store.getters.sshReq}`;\n      window.open(downloadUrl);\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}